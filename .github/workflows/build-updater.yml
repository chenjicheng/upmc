# ============================================================
# GitHub Actions: 编译更新器并发布
# ============================================================
# 触发条件：推送 v* 格式的 tag（如 v0.3.5）
#
# 流程：
#   1. 校验 tag 版本号与 Cargo.toml 一致
#   2. 编译 Rust 更新器（Windows Release）
#   3. 上传 updater.exe 到 tools Release（向后兼容旧版更新器）
#   4. 为当前 tag 创建正式 GitHub Release + 附带 updater.exe
#   5. 从最新 Release 动态生成 version.json
#   6. 部署 version.json 到 GitHub Pages (upmc.chenjicheng.cn)
#
# 前提：
#   - GitHub Releases 中已存在名为 "tools" 的 Release
#   - tag 版本号与 updater-rs/Cargo.toml 中的 version 一致
#   - 仓库 Settings → Pages → Source 选择 "GitHub Actions"
#   - DNS: upmc.chenjicheng.cn CNAME → <username>.github.io
# ============================================================

name: 编译更新器

on:
  push:
    tags: ['v*']
    # main 分支推送时也运行，用于预热 Cargo 缓存
    # （tag push 只能读取默认分支或同 tag 的缓存）
    branches: [main]

  # 允许手动触发（Actions 页面点 "Run workflow"）
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

# 串行执行，避免并发冲突
concurrency:
  group: build-updater
  cancel-in-progress: false

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 校验版本号一致
        if: startsWith(github.ref, 'refs/tags/v')
        shell: pwsh
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          $tagVersion = $env:TAG_NAME.TrimStart("v")
          $cargoContent = Get-Content updater-rs/Cargo.toml -Raw
          if ($cargoContent -match '(?s)\[package\].*?version\s*=\s*"([^"]+)"') {
            $cargoVersion = $Matches[1]
          } else {
            Write-Error "无法从 Cargo.toml 读取版本号"
            exit 1
          }
          if ($tagVersion -ne $cargoVersion) {
            Write-Error "Tag 版本 ($tagVersion) 与 Cargo.toml 版本 ($cargoVersion) 不一致！请确保两者一致后重新打 tag。"
            exit 1
          }
          Write-Host "版本号校验通过: $tagVersion" -ForegroundColor Green

      - name: 安装 Rust
        uses: dtolnay/rust-toolchain@stable

      - name: 缓存 Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: updater-rs -> target
          cache-on-failure: true
          # tag 触发时 ref 不是分支，需要固定 key 才能跨 tag 复用缓存
          shared-key: updater-release

      - name: 编译 Release
        working-directory: updater-rs
        run: cargo build --release

      - name: 上传到 tools Release（向后兼容）
        if: startsWith(github.ref, 'refs/tags/v')
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          Copy-Item updater-rs/target/release/upmc-updater.exe updater.exe
          $size = [math]::Round((Get-Item updater.exe).Length / 1MB, 2)
          Write-Host "产物大小: $size MB"
          gh release upload tools updater.exe --clobber
          Write-Host "已上传到 tools Release" -ForegroundColor Green

      - name: 创建正式 Release
        if: startsWith(github.ref, 'refs/tags/v')
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          # 如果该 tag 的 Release 已存在，先删除
          gh release delete $env:TAG_NAME --yes 2>$null
          # 创建新 Release 并附带 exe
          gh release create $env:TAG_NAME updater.exe `
            --title $env:TAG_NAME `
            --generate-notes
          Write-Host "已创建 Release $env:TAG_NAME" -ForegroundColor Green

  deploy:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 生成 version.json
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 从当前 tag 的 Release 获取信息
          RELEASE_JSON=$(gh release view "${{ github.ref_name }}" --json tagName,assets)
          TAG_NAME=$(echo "$RELEASE_JSON" | jq -r '.tagName')
          VERSION="${TAG_NAME#v}"
          DOWNLOAD_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name == "updater.exe") | .url')
          DOWNLOAD_URL="https://ghfast.top/${DOWNLOAD_URL#https://}"

          # 组装 _site
          mkdir -p _site
          echo "{\"version\":\"${VERSION}\",\"download_url\":\"${DOWNLOAD_URL}\"}" > _site/version.json
          cp CNAME _site/

          echo "=== version.json ==="
          cat _site/version.json
          echo ""
          echo "版本: $VERSION"
          echo "下载: $DOWNLOAD_URL"

      - name: 配置 Pages
        uses: actions/configure-pages@v5

      - name: 上传 Pages 产物
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: 部署到 GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
