# ============================================================
# GitHub Actions: 自动发布到 GitHub Pages
# ============================================================
# 触发条件：推送到 main 分支（packwiz/ 或 server.json 有变更时）
#
# 流程：
#   1. 从 packwiz/ 和 server.json 组装部署内容
#   2. 推送到 gh-pages 分支，由 GitHub Pages 自动部署
#
# 前提：
#   - 仓库 Settings → Pages → Source 选择 "Deploy from a branch"
#   - Branch 选择 "gh-pages"，目录选择 "/ (root)"
# ============================================================

name: 发布整合包索引

on:
  push:
    branches: [main]
    paths:
      - 'packwiz/**'
      - 'server.json'

  # 允许手动触发（Actions 页面点 "Run workflow"）
  workflow_dispatch:

permissions:
  contents: write

# 同一时间只允许一个部署，跳过排队中的
concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 组装部署内容
        run: |
          mkdir -p _site

          # 复制 packwiz 索引文件
          if [ -d "packwiz" ]; then
            cp -r packwiz/* _site/
          fi

          # 复制 server.json
          cp server.json _site/

          # 添加 .nojekyll 避免 GitHub Pages 忽略以 _ 开头的文件
          touch _site/.nojekyll

          echo "=== 部署内容 ==="
          find _site -type f | head -50

      - name: 部署到 gh-pages 分支
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "deploy: ${{ github.sha }}"
          cname: update.mc.chenjicheng.cn
